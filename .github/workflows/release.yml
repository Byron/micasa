# Copyright 2026 Phillip Cloud
# Licensed under the Apache License, Version 2.0

name: Release Artifacts

on:
  release:
    types: [published]

concurrency:
  group: release-artifacts
  cancel-in-progress: false

permissions:
  contents: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  binaries:
    name: Build (${{ matrix.os }}/${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            os: linux
            arch: amd64
            target: x86_64-unknown-linux-gnu
            ext: ""
          - runner: macos-latest
            os: macos
            arch: amd64
            target: x86_64-apple-darwin
            ext: ""
          - runner: windows-latest
            os: windows
            arch: amd64
            target: x86_64-pc-windows-msvc
            ext: ".exe"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.release.tag_name }}
          persist-credentials: false

      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Build (Unix)
        if: matrix.os != 'windows'
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
        run: |
          cargo build --release --locked --package micasa-cli --target "$TARGET"
          cp "target/$TARGET/release/micasa${{ matrix.ext }}" "micasa${{ matrix.ext }}"

      - name: Build (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.target }}
        run: |
          cargo build --release --locked --package micasa-cli --target "$env:TARGET"
          Copy-Item "target\$env:TARGET\release\micasa${{ matrix.ext }}" "micasa${{ matrix.ext }}"

      - name: Package (Unix)
        if: matrix.os != 'windows'
        shell: bash
        env:
          OS: ${{ matrix.os }}
          ARCH: ${{ matrix.arch }}
        run: |
          name="micasa_${OS}_${ARCH}"
          tar czf "${name}.tar.gz" micasa

      - name: Package (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        env:
          OS: ${{ matrix.os }}
          ARCH: ${{ matrix.arch }}
        run: |
          $name = "micasa_${env:OS}_${env:ARCH}"
          Compress-Archive -Path "micasa.exe" -DestinationPath "$name.zip"

      - name: Upload release asset (Unix)
        if: matrix.os != 'windows'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          OS: ${{ matrix.os }}
          ARCH: ${{ matrix.arch }}
        run: |
          name="micasa_${OS}_${ARCH}"
          gh release upload "$RELEASE_TAG" "${name}.tar.gz"

      - name: Upload release asset (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          OS: ${{ matrix.os }}
          ARCH: ${{ matrix.arch }}
        run: |
          $name = "micasa_${env:OS}_${env:ARCH}"
          gh release upload "$env:RELEASE_TAG" "$name.zip"

  checksums:
    name: Checksums
    needs: binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: gh release download "$RELEASE_TAG" --dir assets

      - name: Generate checksums
        run: |
          cd assets
          sha256sum * > checksums.txt

      - name: Upload checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: gh release upload "$RELEASE_TAG" assets/checksums.txt

  container:
    name: Build & Push Container
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.release.tag_name }}
          persist-credentials: false

      - uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31

      - name: Build container image
        run: nix build '.#micasa-container'

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ github.event.release.tag_name }}
            type=semver,pattern={{major}}.{{minor}},value=${{ github.event.release.tag_name }}
            type=semver,pattern={{major}},value=${{ github.event.release.tag_name }}
            type=raw,value=latest

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Load, tag, and push image
        run: |
          docker load < result
          for tag in $TAGS; do
            docker tag micasa:latest "$tag"
            docker push "$tag"
          done
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
